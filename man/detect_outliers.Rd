% Generated by roxygen2: do not edit by hand
% Please edit documentation in R/outlier_detection.R
\name{detect_outliers}
\alias{detect_outliers}
\title{Detect outliers with guardrails, consensus, and seasonal fallbacks}
\usage{
detect_outliers(
  data,
  column,
  record_id = "record_id",
  admin_level = c("adm1", "adm2"),
  date = "date",
  time_mode = c("by_month", "across_time", "within_year"),
  value_type = c("count", "rate"),
  strictness = c("balanced", "lenient", "strict", "advanced"),
  sd_multiplier = 3,
  mad_constant = 1.4826,
  mad_multiplier = 9,
  iqr_multiplier = 2,
  min_n = 8,
  reporting_rate_col = NULL,
  reporting_rate_min = 0.5,
  key_indicators_hf = NULL,
  binary_classification = FALSE,
  methods = c("iqr", "median", "mean", "consensus"),
  consensus_rule = 2,
  output_profile = c("standard", "lean", "audit"),
  seasonal_pool_years = 5,
  min_years_per_month = 3,
  verbose = TRUE,
  cache_stats = TRUE,
  cache_dir = NULL,
  spatial_level = NULL
)
}
\arguments{
\item{data}{Data frame containing the indicator to analyse.}

\item{column}{Name of the numeric column to evaluate.}

\item{record_id}{Unique record identifier column.}

\item{admin_level}{Character vector of administrative level columns for
parallel grouping, ordered from higher to lower resolution.
Defaults to \code{c("adm1", "adm2")}. Used for efficient data.table grouping.}

\item{date}{Date column (Date, POSIXt, or parseable character string).
Year, month, and yearmon are automatically derived from this column.}

\item{time_mode}{Pooling strategy: \code{"across_time"}, \code{"within_year"}, or
\code{"by_month"}. \code{"by_month"} activates the seasonal fallback ladder.}

\item{value_type}{Indicator type: \code{"count"} or \code{"rate"}. Counts floor lower
bounds at 0.}

\item{strictness}{Strictness preset: \code{"lenient"}, \code{"balanced"}, \code{"strict"},
or \code{"advanced"}. Presets map to method multipliers. If not \code{"advanced"},
any manual multipliers are \strong{ignored}.}

\item{sd_multiplier}{Width (in SD units) for the mean method
(used only when \code{strictness = "advanced"}).}

\item{mad_constant}{Constant passed to \code{stats::mad()} in advanced mode
(default 1.4826).}

\item{mad_multiplier}{Width multiplier for the MAD method (advanced mode).}

\item{iqr_multiplier}{Tukey fence multiplier for the IQR method
(advanced mode).}

\item{min_n}{Minimum observations required in the active comparison bucket
before flagging is attempted (applies to any seasonal bucket or fallback).}

\item{reporting_rate_col}{Optional column with reporting completeness in
\verb{[0, 1]}.}

\item{reporting_rate_min}{Minimum acceptable reporting rate. Rows below the
threshold receive \code{reason = "low_reporting"} and are not flagged.}

\item{key_indicators_hf}{Optional character vector of indicator names used to
determine facility activeness. If supplied, the function calls
\code{classify_facility_activity()} internally to exclude inactive health
facilities from outlier detection. Inactive facility-months are tagged with
\code{reason = "inactive_facility"} and excluded from detection. If \code{NULL}
(default), activeness filtering is skipped. Typical indicators include
\code{"allout"}, \code{"test"}, or \code{"conf"}. This adjustment prevents false positives
caused by facilities that start or stop reporting mid-period.}

\item{binary_classification}{Logical. When \code{key_indicators_hf} is provided,
determines the classification method passed to \code{classify_facility_activity()}.
If TRUE, uses binary classification ("Active", "Non-Active"). If FALSE
(default), uses three-level classification ("Active Reporting",
"Active Facility - Not Reporting", "Inactive Facility").}

\item{methods}{Character vector specifying which outlier detection
methods to use: "iqr" (Interquartile Range), "median" (Median Absolute
Deviation), "mean" (Mean +/- SD), and/or "consensus".
Default is \code{c("iqr", "median", "mean", "consensus")}.
For consensus, at least two other methods must be selected.}

\item{consensus_rule}{Number of methods that must agree (\code{1}, \code{2}, or \code{3})
for the consensus flag to call an outlier. Default \code{2}.}

\item{output_profile}{Controls the amount of detail returned:
\code{"lean"} (minimal columns: id, admin, date, value, consensus flag, reason),
\code{"standard"} (lean + per-method flags + bounds + seasonality mode),
\code{"audit"} (all columns for full reproducibility). Default \code{"standard"}.}

\item{seasonal_pool_years}{Total window size (in years) for same-month
pooling when \code{time_mode = "by_month"}. The window is centered on the
target year, looking both backward and forward in time (e.g., with
\code{seasonal_pool_years = 5}, compares with +/-2 years for each side).
Default \code{5}.}

\item{min_years_per_month}{Minimum distinct years required in the same-month
pool before moving to a fallback. Default \code{3}.}

\item{verbose}{Logical. When \code{TRUE}, prints an informative summary showing
which methods are being applied, the pooling strategy, strictness settings,
guardrails, and consensus rule. Default is \code{FALSE}.}

\item{cache_stats}{Logical. Cache intermediate statistical calculations
to improve performance across seasonal pools. Default is \code{TRUE}.}

\item{cache_dir}{Character string specifying directory for file-based cache.
If NULL (default), uses project cache directory or tempdir(). Cache persists
across R sessions for reproducible performance gains.}

\item{spatial_level}{Character string specifying the finest spatial unit
for analysis (e.g., "hf_uid" for facility-level). When specified,
\code{admin_levels} defines grouping boundaries while \code{spatial_level} defines
the unit of analysis. This prevents excessive grouping while maintaining
spatial granularity. Default is \code{NULL} (uses most granular admin level).}
}
\value{
Tibble with outlier classifications and metadata. Columns include:
identifiers (\code{record_id}, admin levels, \code{yearmon}, \code{year}, derived
\code{month}), \code{column_name}, \code{value}, \code{value_type}, scale stats (\code{mean},
\code{sd}, \code{median}, \code{mad}, \code{q1}, \code{q3}, \code{iqr}), method bounds, residual stats
(if residual fallback), \code{n_in_group}, guardrail \code{reason}, method flags
(optional), \code{outlier_flag_consensus}, seasonality descriptors, strictness
multipliers, fallback information, and (if activeness filtering was
applied) \code{activeness_applied} and \code{key_indicators_used}.
}
\description{
\code{detect_outliers()} evaluates a numeric indicator by administrative unit and
time using three methods (mean +/- SD, median +/- MAD, Tukey IQR).
It enforces reporting and sample-size guardrails, supports strictness
presets, and when requested applies a seasonality ladder
(same-month -> neighbours -> residual -> across-time) to select stable
comparison pools. It returns per-method flags (optional), a consensus
classification, scale statistics, and metadata recording any fallback used.
}
\details{
\strong{Workflow}
\enumerate{
\item Validation & prep: confirm required columns, coerce target to numeric
safely, derive month from \code{yearmon}.
\item Activeness filtering (if \code{key_indicators_hf} is supplied): call
\code{classify_facility_activity()} to tag inactive facilities. Inactive
facility-months are excluded from detection and assigned
\code{reason = "inactive_facility"}.
\item Strictness: presets map to (SD, MAD, IQR) multipliers; advanced mode
honours manual multipliers. On across-time fallback the strictness shifts
one step toward lenient.
\item Guardrails: rows failing \code{reporting_rate_min} or \code{min_n} bypass flagging
and record \code{reason} (\code{low_reporting}, \code{insufficient_n},
\code{insufficient_seasonal_history}).
\item Seasonality (if \code{time_mode = "by_month"}): ladder applied in order:
same-month (+/-\code{seasonal_pool_years/2} years, excluding target year),
neighbours (months m-1, m, m+1 with weights 1:2:1 within the same
+/- years window), residual (remove month fixed effects), across-time
(with strictness shift), then exclusion if still inadequate. Each row
records \code{seasonality_mode_used}, window text, and any fallback reason.
\item Flagging: each method classifies rows respecting guardrails and unstable
scales (when \code{sd}, \code{mad}, or \code{iqr} equals zero the method is suppressed
and marked \code{unstable_scale}).
\item Consensus: final \code{outlier_flag_consensus} requires at least
\code{consensus_rule} methods to agree over available (non-suppressed) methods.
}

\strong{Facility activeness adjustment}

When inactive or newly activated health facilities are included in aggregated
totals, apparent spikes or dips can occur that do not represent real
epidemiological changes. For example, if ten new facilities start reporting
in Matoto in mid-2022, the total number of confirmed cases rises even if
incidence per facility remains constant. To prevent such artefacts,
\code{detect_outliers()} can optionally apply activeness filtering using
\code{classify_facility_activity()}. Only active facilities (those that reported
at least one of the specified key indicators in a given month) contribute to
the comparison pool for outlier detection. This step improves
interpretability of results and reduces false positives in areas with
variable reporting completeness or frequent facility additions.

\strong{Presets}
\itemize{
\item lenient: SD 4.0; MAD constant 1.4826, MAD mult 12; IQR 3.0
\item balanced: SD 3.0; MAD constant 1.4826, MAD mult 9; IQR 2.0
\item strict: SD 2.5; MAD constant 1.4826, MAD mult 6; IQR 1.5
\item advanced: use user-supplied multipliers
}

\strong{Seasonality ladder thresholds}
\itemize{
\item same-month requires \code{min_years_per_month} and \code{min_n} within the
bidirectional \code{seasonal_pool_years} window (centered on target year);
otherwise fall back as described above.
}

The returned tibble always contains identifiers, scale statistics, bounds,
strictness and seasonality metadata, and the guardrail reason. When
\code{output_profile = "standard"} or \code{"audit"}, method-specific flags are
included alongside the consensus.
}
\examples{
\dontrun{
# 1) Minimal consensus output at adm1-only level
detect_outliers(
  data = malaria_data,
  column = "confirmed_cases",
  date = "date",
  record_id = "facility_id",
  admin_levels = c("adm1"),        # ignore adm2 if not present
  time_mode = "across_time"
)

# 2) Seasonality with fallbacks
#    (same-month -> neighbours -> residual -> across-time)
detect_outliers(
  data = malaria_data,
  column = "confirmed_cases",
  date = "date",
  admin_levels = c("adm1"),
  time_mode = "by_month",
  seasonal_pool_years = 5,
  min_years_per_month = 3,
  consensus_rule = 2,
  output_profile = "audit"
)

# 3) Advanced overrides for rates
detect_outliers(
  data = malaria_data,
  column = "positivity_rate",
  date = "date",
  value_type = "rate",
  strictness = "advanced",
  sd_multiplier = 2.5,
  mad_multiplier = 7,
  iqr_multiplier = 1.8,
  min_n = 10,
  output_profile = "audit"
)

# 4) With facility activeness filtering
detect_outliers(
  data = malaria_data,
  column = "conf",
  date = "date",
  admin_levels = c("adm1", "adm2"),
  time_mode = "by_month",
  key_indicators_hf = c("allout", "test", "conf")
)

# 5) With binary activeness classification
detect_outliers(
  data = malaria_data,
  column = "conf",
  date = "date",
  admin_levels = c("adm1", "adm2"),
  time_mode = "by_month",
  key_indicators_hf = c("allout", "test", "conf"),
  binary_classification = TRUE
)
}
}
